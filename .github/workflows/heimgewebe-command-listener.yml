name: Heimgewebe command listener

on:
  repository_dispatch:
    types: [heimgewebe-command]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  handle:
    name: Handle Heimgewebe command
    runs-on: ubuntu-latest
    steps:
      - name: Process command
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const payload = context.payload.client_payload || {};

            const {
              source_repository,
              source_issue_number,
              source_comment_author,
              command,
              target_repo,
              args,
              raw_comment,
            } = payload;

            core.info(`Received Heimgewebe command in sichter: ${JSON.stringify(payload)}`);

            // Nur Events verarbeiten, die wirklich f√ºr "sichter" gedacht sind
            if (target_repo !== 'sichter') {
              core.info(`Ignoring command for other target_repo: ${target_repo}`);
              return;
            }

            if (!source_repository || !source_issue_number) {
              core.warning('Missing source_repository or source_issue_number in payload ‚Äì cannot reply.');
              return;
            }

            const [owner, repo] = source_repository.split('/');
            if (!owner || !repo) {
              core.warning(`Invalid source_repository value: ${source_repository}`);
              return;
            }

            const niceArgs = (args || '').trim();

            const bodyLines = [
              `üëÄ **sichter** hat deinen Heimgewebe-Befehl empfangen.`,
              '',
              `- Befehl: \`${command}\`${niceArgs ? ' `' + niceArgs + '`' : ''}`,
              `- Ausl√∂ser: @${source_comment_author || 'unbekannt'}`,
              '',
              '> Dies ist aktuell nur ein Platzhalter-Check. Die eigentlichen Analysen lassen sich hier sp√§ter einh√§ngen.',
            ];

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: source_issue_number,
              body: bodyLines.join('\n'),
            });

            core.info('Reply comment posted successfully.');
