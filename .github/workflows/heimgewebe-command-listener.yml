name: Heimgewebe command listener (sichter)

on:
  # Wird vom Dispatcher (metarepo) per repository_dispatch ausgel√∂st.
  repository_dispatch:
    types:
      - heimgewebe-command

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  # Ziel-Repository, f√ºr das dieser Listener zust√§ndig ist
  HEIMGEWEBE_TARGET_REPO: sichter
  # Optional: erlaubte Kommandos (kommagetrennt); leer = alle zulassen
  HEIMGEWEBE_ALLOWED_COMMANDS: quick,deep

jobs:
  handle:
    name: Handle Heimgewebe command
    runs-on: ubuntu-latest
    steps:
      - name: Process Heimgewebe command
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Grundcheck: Payload vorhanden?
            if (!context.payload) {
              core.warning('No payload on repository_dispatch event ‚Äì nothing to do.');
              return;
            }

            const eventType = context.payload.action || 'unknown';
            core.info(`repository_dispatch action: ${eventType}`);

            // Sicherheitsnetz: Wir erwarten "heimgewebe-command"
            if (eventType !== 'heimgewebe-command') {
              core.info(`Ignoring repository_dispatch with action "${eventType}".`);
              return;
            }

            const payload = context.payload.client_payload || {};
            core.info(`Raw client_payload: ${JSON.stringify(payload)}`);

            const {
              version,
              source_repository,
              source_issue_number,
              source_comment_author,
              command,
              target_repo,
              args,
              raw_comment,
            } = payload;

            // Versionierung: aktuell nur v1 vorgesehen, andere Versionen nur loggen
            if (version !== 1) {
              core.warning(`Unexpected Heimgewebe payload version: ${version}. Listener is built for version 1.`);
            }

            const expectedTarget = process.env.HEIMGEWEBE_TARGET_REPO || 'sichter';
            if (target_repo !== expectedTarget) {
              core.info(`Command is for target_repo "${target_repo}", but this listener is "${expectedTarget}" ‚Äì ignoring.`);
              return;
            }

            if (!source_repository || !source_issue_number) {
              core.warning('Missing source_repository or source_issue_number in payload ‚Äì cannot reply.');
              return;
            }

            const [owner, repo] = String(source_repository).split('/');
            if (!owner || !repo) {
              core.warning(`Invalid source_repository value: ${source_repository}`);
              return;
            }

            const allowedCommandsEnv = process.env.HEIMGEWEBE_ALLOWED_COMMANDS || '';
            const allowedCommands = allowedCommandsEnv
              .split(',')
              .map(s => s.trim())
              .filter(Boolean);

            if (allowedCommands.length > 0 && !allowedCommands.includes(command)) {
              core.info(
                `Command "${command}" not in allowed command list: [${allowedCommands.join(', ')}] ‚Äì ignoring.`
              );
              return;
            }

            const niceArgs = (args || '').trim();
            const displayCommand =
              '`' + String(command || 'unbekannt') + '`' +
              (niceArgs ? ' `' + niceArgs + '`' : '');

            const summaryLines = [];

            summaryLines.push('üëÄ **sichter** hat deinen Heimgewebe-Befehl empfangen.');
            summaryLines.push('');
            summaryLines.push(`- Befehl: ${displayCommand}`);
            summaryLines.push(`- Ausl√∂ser: @${source_comment_author || 'unbekannt'}`);

            // Ausl√∂ser-Kommentar optional als Snippet anh√§ngen
            if (raw_comment) {
              const maxLen = 500;
              let snippet = String(raw_comment).replace(/[\r\n]+/g, ' ');
              if (snippet.length > maxLen) {
                snippet = snippet.slice(0, maxLen) + ' ‚Ä¶(gek√ºrzt)';
              }

              summaryLines.push('');
              summaryLines.push('<details>');
              summaryLines.push('<summary>Ausl√∂ser-Kommentar</summary>');
              summaryLines.push('');
              summaryLines.push(snippet);
              summaryLines.push('');
              summaryLines.push('</details>');
            }

            summaryLines.push('');
            summaryLines.push(
              '> Dies ist aktuell nur ein Platzhalter-Check von **sichter**. ' +
              'Die eigentlichen Analysen werden sp√§ter hier eingeh√§ngt.'
            );

            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: source_issue_number,
                body: summaryLines.join('\n'),
              });
              core.info('Reply comment posted successfully.');
            } catch (error) {
              core.setFailed(`Failed to post reply comment: ${error.message}`);
            }
