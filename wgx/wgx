#!/bin/bash
set -euo pipefail

# wgx - The main script that parses the profile and runs tasks

# Find the root directory of the wgx installation
WGX_ROOT=$(cd "$(dirname "$0")/.." && pwd)
PROFILE="$WGX_ROOT/.wgx/profile.yml"

# Source the YAML parser
source "$WGX_ROOT/wgx/lib/parse_yaml.sh"

# The first argument is the subcommand
SUBCOMMAND="${1:-}"

if [[ -z "$SUBCOMMAND" ]];  then
  echo "Usage: wgx <subcommand>" >&2
  exit 1
fi

# Parse the profile and execute the task
eval "$(parse_yaml "$PROFILE" "wgx_")"

TASK_VAR="wgx_tasks_$SUBCOMMAND"
TASK_COMMAND="${!TASK_VAR:-}"

if [[ -z "$TASK_COMMAND" ]]; then
  echo "Warning: No task named '$SUBCOMMAND' defined in $PROFILE" >&2
  exit 0
fi

echo "Running $SUBCOMMAND task from profile..."
bash -c "$TASK_COMMAND"
