#!/usr/bin/env bash
set -euo pipefail
MODE="changed"
if [[ "${1:-}" == "--all" ]]; then
 MODE="all"
 shift || true
elif [[ "${1:-}" == "--changed" ]]; then
 MODE="changed"
 shift || true
fi

POLICY_PATH="${XDG_CONFIG_HOME:-$HOME/.config}/sichter/policy.yml"
if [[ ! -f "$POLICY_PATH" ]]; then
 POLICY_PATH="$(cd "$(dirname "$0")/.." && pwd)/config/policy.yml"
fi

eval "$(python3 - <<'PY'
import pathlib
import sys
try:
 import yaml
except ModuleNotFoundError:
 print('ORG=heimgewebe')
 print('AUTO_PR=1')
 sys.exit(0)
policy_path = pathlib.Path(r"$POLICY_PATH")
policy = yaml.safe_load(policy_path.read_text()) if policy_path.exists() else {}
org = policy.get("org", "heimgewebe")
auto = 1 if policy.get("auto_pr", True) else 0
print(f"ORG={org}")
print(f"AUTO_PR={auto}")
PY
)"

LOG_DIR="$HOME/sichter/logs"
mkdir -p "$LOG_DIR"
LOG="$LOG_DIR/pr-actions.log"

ts(){ date -Is; }
say(){ echo "[$(ts)] $*" | tee -a "$LOG"; }

say "===== Sichter PR Sweep start (${MODE}) ====="

collect_repos() {
 if [[ "$MODE" == "all" ]]; then
  gh repo list "$ORG" --limit 100 --json name -q '.[].name' 2>/dev/null || true
 else
  local repos
  repos=$(find "$HOME/repos" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' 2>/dev/null)
  if [[ -n "$repos" ]]; then
   printf '%s\n' "$repos"
  else
   gh repo list "$ORG" --limit 50 --json name -q '.[].name' 2>/dev/null || true
  fi
 fi
}

mapfile -t REPOS < <(collect_repos)

if [[ "${#REPOS[@]}" -eq 0 ]]; then
 say "Keine Ziel-Repos"
 exit 0
fi

for repo in "${REPOS[@]}"; do
 [[ -n "$repo" ]] || continue
 REPO_PATH="$HOME/repos/$repo"
 if [[ ! -d "$REPO_PATH/.git" ]]; then
  gh repo clone "$ORG/$repo" "$REPO_PATH" >>"$LOG" 2>&1 || true
 fi
 [[ -d "$REPO_PATH/.git" ]] || { say "skip $repo (kein git)"; continue; }

 pushd "$REPO_PATH" >/dev/null || continue
 git fetch origin --prune --tags >>"$LOG" 2>&1 || true
 git switch --detach origin/main >>"$LOG" 2>&1 || git checkout --detach origin/main >>"$LOG" 2>&1 || true
 BR="sichter/autofix-$(date +%Y%m%d-%H%M%S)"
 git switch -C "$BR" >>"$LOG" 2>&1 || git checkout -B "$BR" >>"$LOG" 2>&1 || true

 if [[ -x "$HOME/sichter/hooks/post-run" ]]; then
  SICHTER_REPO_ROOT="$REPO_PATH" "$HOME/sichter/hooks/post-run" >>"$LOG" 2>&1 || true
 fi

 git add -A >>"$LOG" 2>&1 || true
 if ! git diff --cached --quiet; then
  git commit -m "hauski: autofix" >>"$LOG" 2>&1 || true
  if [[ "$AUTO_PR" == "1" ]]; then
   git push --set-upstream origin "$BR" --force-with-lease >>"$LOG" 2>&1 || true
   URL="$(gh pr view "$BR" --json url -q .url 2>/dev/null || true)"
   if [[ -z "$URL" ]]; then
    gh pr create --base main --fill --title "Sichter: auto PR ($repo)" \
    --label sichter --label automation >>"$LOG" 2>&1 || true
    URL="$(gh pr view "$BR" --json url -q .url 2>/dev/null || true)"
   fi
   if [[ -n "$URL" ]]; then
    say "PR ${repo} -> $URL"
   else
    say "PR ${repo} erstellt (URL unbekannt)"
   fi
  else
   say "Commit ${repo} (Auto-PR deaktiviert)"
  fi
 else
  say "Keine Ã„nderungen in ${repo}"
 fi
 popd >/dev/null || true

done

say "===== Sichter PR Sweep done (${MODE}) ====="
