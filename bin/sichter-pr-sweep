#!/usr/bin/env bash
set -euo pipefail

MODE="${MODE:---changed}"
if [[ "${1:-}" == "--all" ]]; then
  MODE="--all"
elif [[ "${1:-}" == "--changed" ]]; then
  MODE="--changed"
fi

# Setup paths and logging
LOG_DIR="$HOME/sichter/logs"
STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/sichter"
EVENTS_DIR="$STATE_DIR/events"
mkdir -p "$LOG_DIR" "$EVENTS_DIR"

LOG="${LOG:-$LOG_DIR/pr-actions.log}"
ORG="${ORG:-heimgewebe}"
AUTO_PR="${SICHTER_AUTO_PR:-1}"
RUN_MODE="${SICHTER_RUN_MODE:-light}"

TS() { date -Is; }
SAY() { echo "[$(TS)] $*"; }
LOG_LINE() { SAY "$*" | tee -a "$LOG"; }

# JSONL event recorder (shell only)
append_event() {
  local json_str="$1"
  # Naive removal of leading/trailing braces
  local core_json="${json_str#\{}"
  core_json="${core_json%\}}"
  local event_file
  event_file="$EVENTS_DIR/sweep-$(date +%Y%m%d).jsonl"
  printf '{"ts": "%s", %s}\n' "$(TS)" "$core_json" >>"$event_file"
}

# Unified result handler
RESULT() {
  local action="$1" repo="$2" branch="$3" detail="${4:--}"
  LOG_LINE "[RESULT][$action] repo=$repo branch=$branch detail=$detail"

  local type="noop"
  [[ "$action" == "PR" ]] && type="pr"
  [[ "$action" == "PUSH" ]] && type="push"
  [[ "$action" == "COMMIT" ]] && type="commit"
  [[ "$action" == "ERROR" ]] && type="error"

  local event_core="\"type\": \"$type\", \"repo\": \"$repo\", \"branch\": \"$branch\""
  if [[ "$action" == "PR" && -n "$detail" ]]; then
    event_core="$event_core, \"url\": \"$detail\""
  elif [[ "$action" == "ERROR" ]]; then
    event_core="$event_core, \"message\": \"$detail\""
  fi
  append_event "{$event_core}"
}

LOG_LINE "===== Sichter PR Sweep start (${MODE} / run_mode=${RUN_MODE}) ====="
append_event '{"type": "start", "message": "PR Sweep started"}'

# Kandidaten
if [[ "$MODE" == "--all" ]]; then
  mapfile -t REPOS < <(gh repo list "$ORG" --limit 100 --json name -q '.[].name' || true)
else
  mapfile -t REPOS < <(find "$HOME/repos" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' 2>/dev/null || true)
  if [[ "${#REPOS[@]}" -eq 0 ]]; then
    mapfile -t REPOS < <(gh repo list "$ORG" --limit 50 --json name -q '.[].name' || true)
  fi
fi

if [[ "${#REPOS[@]}" -eq 0 ]]; then
  LOG_LINE "Keine Ziel-Repos"
  LOG_LINE "===== Sichter PR Sweep done (${MODE}) ====="
  append_event '{"type": "stop", "message": "No repos found"}'
  exit 0
fi

for r in "${REPOS[@]}"; do
  [[ -z "$r" ]] && continue
  REPO_PATH="$HOME/repos/$r"
  if [[ ! -d "$REPO_PATH/.git" ]]; then
    LOG_LINE "Cloning missing repo $ORG/$r"
    gh repo clone "$ORG/$r" "$REPO_PATH" >/dev/null 2>&1 || true
    [[ ! -d "$REPO_PATH/.git" ]] && {
      RESULT "ERROR" "$r" "-" "clone failed"
      continue
    }
  fi

  pushd "$REPO_PATH" >/dev/null || {
    RESULT "ERROR" "$r" "-" "cannot enter repo"
    continue
  }

  git fetch origin --prune --tags >/dev/null 2>&1 || true
  if ! git switch --detach "origin/main" >/dev/null 2>&1; then
    git checkout --detach "origin/main" >/dev/null 2>&1 || true
  fi

  BR="sichter/autofix-$(date +%Y%m%d-%H%M%S)"
  git switch -C "$BR" >/dev/null 2>&1 || git checkout -B "$BR" >/dev/null 2>&1

  export SICHTER_RUN_MODE="$RUN_MODE"
  if [[ -x "$HOME/sichter/hooks/post-run" ]]; then
    LOG_LINE "Running repo hook for $r"
    HAUSKI_AUTO_APPLY=1 HAUSKI_AUTO_COMMIT=0 HAUSKI_AUTO_PR=0 "$HOME/sichter/hooks/post-run" >/dev/null 2>&1 || true
  fi

  # Light integrated check for visibility
  if [[ "$RUN_MODE" == "light" ]]; then
    git status --short >/dev/null 2>&1 || true
  fi

  git add -A || true
  if git diff --cached --quiet; then
    RESULT "NOCHANGE" "$r" "$BR" "no staged updates"
    popd >/dev/null || true
    continue
  fi

  if ! git commit -m "sichter: automated sweep" >/dev/null 2>&1; then
    RESULT "ERROR" "$r" "$BR" "commit failed"
    popd >/dev/null || true
    continue
  fi

  if [[ "$AUTO_PR" == "1" ]]; then
    git push --set-upstream origin "$BR" --force-with-lease >/dev/null 2>&1 || true
    URL="$(gh pr view "$BR" --json url -q .url 2>/dev/null || true)"
    if [[ -z "$URL" ]]; then
      gh pr create --base main --fill --title "Sichter: auto PR ($r)" --label sichter --label automation >/dev/null 2>&1 || true
      URL="$(gh pr view "$BR" --json url -q .url 2>/dev/null || true)"
    fi
    if [[ -n "$URL" ]]; then
      RESULT "PR" "$r" "$BR" "$URL"
    else
      RESULT "PUSH" "$r" "$BR" "pushed (PR n/a)"
    fi
  else
    RESULT "COMMIT" "$r" "$BR" "Auto-PR=off"
  fi

  popd >/dev/null || true

done

LOG_LINE "===== Sichter PR Sweep done (${MODE}) ====="
append_event '{"type": "stop", "message": "PR Sweep finished"}'
