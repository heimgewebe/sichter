#!/usr/bin/env bash
set -euo pipefail
MODE="changed"
REPORT_FILE=""
while [ $# -gt 0 ]; do
 case "$1" in
 --all)
 MODE="all"
 ;;
 --changed)
 MODE="changed"
 ;;
 --report)
 REPORT_FILE="$2"
 shift
 ;;
 *)
 break
 ;;
 esac
 shift || true
done

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
LOG_DIR="$HOME/sichter/logs"
mkdir -p "$LOG_DIR"
TS="$(date +%Y%m%d-%H%M%S)"
LOG_FILE="$LOG_DIR/omnicheck-${MODE}-${TS}.log"
if [ -z "$REPORT_FILE" ]; then
 REPORT_FILE="$LOG_DIR/omnicheck-${MODE}-${TS}.md"
fi

POLICY_PATH="${XDG_CONFIG_HOME:-$HOME/.config}/sichter/policy.yml"
if [ ! -f "$POLICY_PATH" ]; then
 POLICY_PATH="$ROOT/config/policy.yml"
fi

SWEEP="$ROOT/bin/sweep"
if [ ! -x "$SWEEP" ]; then
 echo "sweep helper nicht gefunden" >&2
 exit 1
fi

echo "# Omnicheck (${MODE})" >"$REPORT_FILE"
echo "Start: $(date -Is)" | tee "$LOG_FILE" >>"$REPORT_FILE"
"$SWEEP" --mode "$MODE" --policy "$POLICY_PATH" "$@" \
 | tee -a "$LOG_FILE" | sed 's/^/ /' >>"$REPORT_FILE"
echo "Ende: $(date -Is)" | tee -a "$LOG_FILE" >>"$REPORT_FILE"

echo "Log: $LOG_FILE"
echo "Report: $REPORT_FILE"
