#!/usr/bin/env bash
set -euo pipefail
export HAUSKI_DEBUG="${HAUSKI_DEBUG:-0}"
LOG="${HOME}/sichter/logs/pr-watch-wrapper.log"
: >"$LOG"
echo "▶ $(date) start pr-watch-safe" >>"$LOG"

# Preflight
~/sichter/bin/hauski-verify-github || {
	echo "❌ gh check failed"
	exit 1
}

# Lauf in eigener Session; filtere typische Fehlpfade:
exec ~/sichter/bin/hauski-pr-watch 2> >(tee -a "$LOG" >&2) | awk '
/^expected an object but got: string/ {
  print "‼️  JSON erwartet, bekam String (vermutlich HTML von docs.github.com).";
  print "   → Token/gh auth prüfen: gh auth status ; gh auth login";
  print "   → Header setzen: Accept: application/vnd.github+json";
}
{ print; fflush(); }'
