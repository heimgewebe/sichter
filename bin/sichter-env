#!/usr/bin/env bash
# bin/sichter-env
# This script is intended to be sourced.

# Guard: Ensure we are running in Bash
if [ -z "${BASH_SOURCE[0]+x}" ]; then
  echo "bin/sichter-env must be sourced from bash (BASH_SOURCE is not set)." >&2
  return 1 2>/dev/null || exit 1
fi

# Robust self-location
_sichter_env_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

# Locate yaml-get (prefer PATH, then relative to script)
if command -v yaml-get >/dev/null 2>&1; then
  _YAML_GET="$(command -v yaml-get)"
else
  _YAML_GET="${_sichter_env_dir}/yaml-get"
fi

# Verify executable
if [ ! -x "$_YAML_GET" ]; then
  echo "Error: yaml-get not found or not executable at $_YAML_GET" >&2
  return 1 2>/dev/null || exit 1
fi

# Helper function
kv() {
  local key="$1" def="${2-}"
  "$_YAML_GET" "$key" "${SICHTER_POLICY_PATH:-$HOME/.config/sichter/policy.yml}" "$def"
}

# Export environment variables
RUN_POLICY="$(kv run_policy periodic)"
INTERVAL_MINUTES="$(kv interval_minutes 5)"
MAX_PARALLEL_JOBS="$(kv max_parallel_jobs 1)"
AUTORUN="$(kv autorun false)"

export SICHTER_RUN_POLICY="$RUN_POLICY"
export SICHTER_INTERVAL_MINUTES="$INTERVAL_MINUTES"
export SICHTER_MAX_PARALLEL_JOBS="$MAX_PARALLEL_JOBS"
export SICHTER_AUTORUN="$AUTORUN"

# Human-readable dump (optional)
if [ "${1-}" = "--print" ]; then
  printf 'policy=%s interval=%s max_jobs=%s autorun=%s\n' \
    "$SICHTER_RUN_POLICY" "$SICHTER_INTERVAL_MINUTES" "$SICHTER_MAX_PARALLEL_JOBS" "$SICHTER_AUTORUN"
fi
