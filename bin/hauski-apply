#!/usr/bin/env bash

# --- SICHTER HEAD-Guard BEGIN ---
ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
REPO="$(basename "$ROOT")"
REPORT_DIR="$HOME/sichter/review/$REPO"
LATEST_MD=""
while IFS= read -r -d "" c; do LATEST_MD="$c"; done < <(find "$REPORT_DIR" -maxdepth 1 -type f -name "*-review.md" -printf "%T@ %p\0" 2>/dev/null | sort -z -nr | cut -z -d" " -f2-)
[ -n "$LATEST_MD" ] || { echo "â„¹ï¸  kein Report"; exit 0; }
curr_head="$(git -C "$ROOT" rev-parse HEAD 2>/dev/null || true)"
grep -aq "$curr_head" "$LATEST_MD" 2>/dev/null || { echo "â„¹ï¸  Report passt nicht zum aktuellen HEAD ($curr_head) â€“ Ã¼berspringe"; exit 0; }
# --- SICHTER HEAD-Guard END ---

# --- SICHTER HEAD-Guard BEGIN ---
ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
REPO="$(basename "$ROOT")"
REPORT_DIR="$HOME/sichter/review/$REPO"
LATEST_MD=""
while IFS= read -r -d "" c; do LATEST_MD="$c"; done < <(find "$REPORT_DIR" -maxdepth 1 -type f -name "*-review.md" -printf "%T@ %p\0" 2>/dev/null | sort -z -nr | cut -z -d" " -f2-)
[ -n "$LATEST_MD" ] || { echo "â„¹ï¸  kein Report"; exit 0; }
curr_head="$(git -C "$ROOT" rev-parse HEAD 2>/dev/null || true)"
grep -aq "$curr_head" "$LATEST_MD" 2>/dev/null || { echo "â„¹ï¸  Report passt nicht zum aktuellen HEAD ($curr_head) â€“ Ã¼berspringe"; exit 0; }
# --- SICHTER HEAD-Guard END ---
set -euo pipefail
ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
[ -n "$ROOT" ] || {
	echo "â­ï¸  kein Git-Repo"
	exit 0
}
REPO="$(basename "$ROOT")"
REPORT_DIR="$HOME/sichter/review/$REPO"
LAST="$(ls -1t "$REPORT_DIR"/*-review.md 2>/dev/null | head -n1 || true)"
[ -n "$LAST" ] || {
	echo "â„¹ï¸  kein Report"
	exit 0
}

cd "$ROOT"
TMP="$(mktemp)"
EXTRACTED=0

# Patch/Diff-Fences robust extrahieren (Variable nicht 'in' nennen)
awk '
  BEGIN{INSIDE=0}
  /^```(patch|diff)/{INSIDE=1; next}
  /^```[[:space:]]*$/ && INSIDE==1 {INSIDE=0; print ""; next}
  INSIDE==1 {print}
' "$LAST" >"$TMP"

if [ -s "$TMP" ]; then
	EXTRACTED=1
	echo "ðŸ§© Patches gefunden â€“ apply (3-way)â€¦"
	if git apply --3way --index "$TMP"; then
		echo "âœ… Patches angewendet."
	else
		echo "âš ï¸  Patch-Apply teilweise fehlgeschlagen (Conflicts mÃ¶glich)."
	fi
else
	echo "â„¹ï¸  Keine \`\`\`patch/\`\`\`diff BlÃ¶cke im Report."
fi

# Auto-Fixer (best effort, nur wenn ein Patch vorhanden war)
if [ "$EXTRACTED" -eq 1 ]; then
	if command -v cargo >/dev/null 2>&1; then
		cargo fmt || true
		cargo clippy --fix --allow-dirty --allow-staged || true
	fi
	if command -v shfmt >/dev/null 2>&1; then
		shfmt -w . || true
	fi
fi

git status --short || true
