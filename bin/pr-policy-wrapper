#!/usr/bin/env bash
set -euo pipefail
POLICY="${HOME}/sichter/policy.yml"
REAL="${HOME}/sichter/bin/hauski-pr-review-all"
LOG="${HOME}/sichter/logs/policy.log"

# Robust self-location
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" >/dev/null 2>&1 && pwd)"

# Locate yaml-get (prefer PATH, then relative to script)
if command -v yaml-get >/dev/null 2>&1; then
  YAML_GET="$(command -v yaml-get)"
else
  YAML_GET="${SCRIPT_DIR}/yaml-get"
fi

if [ ! -x "$YAML_GET" ]; then
  echo "Error: yaml-get not found or not executable at $YAML_GET" >&2
  exit 1
fi

red() { printf "\033[31m%s\033[0m\n" "$*"; }
yellow() { printf "\033[33m%s\033[0m\n" "$*"; }
green() { printf "\033[32m%s\033[0m\n" "$*"; }

if [ ! -x "$REAL" ]; then
  yellow "Hinweis: echter PR-Ersteller fehlt/ist nicht ausführbar: $REAL"
  exit 0
fi

ALLOW_DUMPS=$("$YAML_GET" "allow_dump_merges" "$POLICY" "false")
ALLOW_DOCS=$("$YAML_GET" "allow_docs_only" "$POLICY" "false")
ALLOW_DEV=$("$YAML_GET" "allow_devcontainer_only" "$POLICY" "false")
SIZE_LIMIT=$("$YAML_GET" "size_limit_changed_files" "$POLICY" "250")
MUST_TOUCH_PATTERNS=$("$YAML_GET" "must_touch_paths" "$POLICY" "")

BASE_REF="${BASE_REF:-origin/main}"
HEAD_REF="${HEAD_REF:-HEAD}"

CHANGED=$(git diff --name-only "${BASE_REF}...${HEAD_REF}" || echo "")
CHANGED_COUNT=$(printf "%s\n" "$CHANGED" | sed '/^$/d' | wc -l)

only_merges=true
only_docs=true
only_devcontainer=true
touches_must=false
while IFS= read -r f; do
  [ -z "$f" ] && continue
  case "$f" in merges/*) ;; *) only_merges=false ;; esac
  case "$f" in *.md | docs/*) ;; *) only_docs=false ;; esac
  case "$f" in .devcontainer/* | .vscode/*) ;; *) only_devcontainer=false ;; esac
  for pat in $MUST_TOUCH_PATTERNS; do
    echo "$f" | grep -Eq "$pat" && {
      touches_must=true
      break
    }
  done
done <<<"$CHANGED"

decision="ALLOW"
reason=""
if [ "$CHANGED_COUNT" -gt "$SIZE_LIMIT" ]; then
  decision="DENY"
  reason="zu groß (${CHANGED_COUNT} > ${SIZE_LIMIT})"
elif $only_merges && [ "$ALLOW_DUMPS" = "false" ]; then
  decision="DENY"
  reason="nur merges/**"
elif $only_docs && [ "$ALLOW_DOCS" = "false" ]; then
  decision="DENY"
  reason="nur Doku"
elif $only_devcontainer && [ "$ALLOW_DEV" = "false" ]; then
  decision="DENY"
  reason="nur Devcontainer/VSCode"
elif [ -n "$MUST_TOUCH_PATTERNS" ] && [ "$touches_must" = "false" ]; then
  decision="DENY"
  reason="trifft must_touch_paths nicht"
fi

ts="$(date -Iseconds)"
if [ "$decision" = "DENY" ]; then
  {
    echo "[$ts] DENY: $reason"
    echo "Changed ($CHANGED_COUNT):"
    printf "  %s\n" "$CHANGED"
  } >>"$LOG"
  exit 0
fi

# Echten Ersteller aufrufen
"$REAL" "$@"

# Nachlauf: ggf. PR-Titel/Branch umbenennen auf "Sichter fixes"
if command -v gh >/dev/null 2>&1; then
  # Letzte offene Auto-PRs im aktuellen Repo umbenennen
  for num in $(gh pr list --state open --json number,title,headRefName \
    --jq '.[] | select(.title|test("HausKI fixes \\(")) | .number'); do
    gh pr edit "$num" --title "$(gh pr view "$num" --json title --jq '.title' | sed 's/^HausKI fixes/Sichter fixes/')"
  done
fi
