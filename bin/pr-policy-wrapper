#!/usr/bin/env bash
set -euo pipefail
POLICY="${HOME}/sichter/policy.yml"
REAL="${HOME}/sichter/bin/hauski-pr-review-all"
LOG="${HOME}/sichter/logs/policy.log"

red() { printf "\033[31m%s\033[0m\n" "$*"; }
yellow() { printf "\033[33m%s\033[0m\n" "$*"; }
green() { printf "\033[32m%s\033[0m\n" "$*"; }

if [ ! -x "$REAL" ]; then
	yellow "Hinweis: echter PR-Ersteller fehlt/ist nicht ausführbar: $REAL"
	exit 0
fi

get_bool() { grep -E "^$1:\s*(true|false)\s*$" "$POLICY" | awk -F: '{gsub(/ /,"",$2);print $2}'; }
get_num() { grep -E "^$1:\s*[0-9]+" "$POLICY" | awk -F: '{gsub(/ /,"",$2);print $2}'; }

ALLOW_DUMPS=$(get_bool "allow_dump_merges" || echo false)
ALLOW_DOCS=$(get_bool "allow_docs_only" || echo false)
ALLOW_DEV=$(get_bool "allow_devcontainer_only" || echo false)
SIZE_LIMIT=$(get_num "size_limit_changed_files" || echo 250)
MUST_TOUCH_PATTERNS=$(awk '/^must_touch_paths:/{flag=1;next}/^[^ ]/{flag=0}flag{print}' "$POLICY" | sed -n 's/^\s*-\s*//p' || true)

BASE_REF="${BASE_REF:-origin/main}"
HEAD_REF="${HEAD_REF:-HEAD}"

CHANGED=$(git diff --name-only "${BASE_REF}...${HEAD_REF}" || echo "")
CHANGED_COUNT=$(printf "%s\n" "$CHANGED" | sed '/^$/d' | wc -l)

only_merges=true
only_docs=true
only_devcontainer=true
touches_must=false
while IFS= read -r f; do
	[ -z "$f" ] && continue
	case "$f" in merges/*) ;; *) only_merges=false ;; esac
	case "$f" in *.md | docs/*) ;; *) only_docs=false ;; esac
	case "$f" in .devcontainer/* | .vscode/*) ;; *) only_devcontainer=false ;; esac
	for pat in $MUST_TOUCH_PATTERNS; do
		echo "$f" | grep -Eq "$pat" && {
			touches_must=true
			break
		}
	done
done <<<"$CHANGED"

decision="ALLOW"
reason=""
if [ "$CHANGED_COUNT" -gt "$SIZE_LIMIT" ]; then
	decision="DENY"
	reason="zu groß (${CHANGED_COUNT} > ${SIZE_LIMIT})"
elif $only_merges && [ "$ALLOW_DUMPS" = "false" ]; then
	decision="DENY"
	reason="nur merges/**"
elif $only_docs && [ "$ALLOW_DOCS" = "false" ]; then
	decision="DENY"
	reason="nur Doku"
elif $only_devcontainer && [ "$ALLOW_DEV" = "false" ]; then
	decision="DENY"
	reason="nur Devcontainer/VSCode"
elif [ -n "$MUST_TOUCH_PATTERNS" ] && [ "$touches_must" = "false" ]; then
	decision="DENY"
	reason="trifft must_touch_paths nicht"
fi

ts="$(date -Iseconds)"
if [ "$decision" = "DENY" ]; then
	{
		echo "[$ts] DENY: $reason"
		echo "Changed ($CHANGED_COUNT):"
		printf "  %s\n" "$CHANGED"
	} >>"$LOG"
	exit 0
fi

# Echten Ersteller aufrufen
"$REAL" "$@"

# Nachlauf: ggf. PR-Titel/Branch umbenennen auf "Sichter fixes"
if command -v gh >/dev/null 2>&1; then
	# Letzte offene Auto-PRs im aktuellen Repo umbenennen
	for num in $(gh pr list --state open --json number,title,headRefName \
		--jq '.[] | select(.title|test("HausKI fixes \\(")) | .number'); do
		gh pr edit "$num" --title "$(gh pr view "$num" --json title --jq '.title' | sed 's/^HausKI fixes/Sichter fixes/')"
	done
fi
