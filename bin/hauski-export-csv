#!/usr/bin/env bash
set -euo pipefail
ROOT="$HOME/sichter/review"
IDX="$ROOT/index.json"
[ -f "$IDX" ] || { echo "[]" >"$IDX"; }
enrich() {
  repo="$1"
  path="$2"
  ts="$3"
  verdict=""
  score=""
  bytes=""
  if [ -f "$path" ]; then
    head200="$(head -n 200 "$path" 2>/dev/null || true)"
    verdict="$(printf '%s\n' "$head200" | grep -m1 -E '^(Verdict|\- *Verdict):' | sed -E 's/^[- ]*Verdict:\s*//I' | tr -d '\r' | tr '[:lower:]' '[:upper:]')"
    score="$(printf '%s\n' "$head200" | grep -m1 -E '(^Score:|Score[[:space:]]*)' | sed -E 's/.*Score[: ]+([0-9]+).*/\1/' || true)"
    bytes="$(wc -c <"$path" 2>/dev/null || echo 0)"
  else
    bytes=0
    verdict="MISSING"
    score=""
  fi
  printf '%s,"%s","%s",%s,%s\n' "$repo" "$ts" "$verdict" "${score:-}" "$bytes"
}
echo 'repo,ts,verdict,score,bytes'
jq -r -c '.[] | [.repo,.path,.ts] | @tsv' "$IDX" | while IFS=$'\t' read -r repo path ts; do
  enrich "$repo" "$path" "$ts"
done
