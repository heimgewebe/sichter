#!/usr/bin/env bash
set -euo pipefail
. "$HOME/.cargo/env" 2>/dev/null || true

# --- FrÃ¼her Exit, wenn kein Repo ---
git rev-parse --show-toplevel >/dev/null 2>&1 || { echo "â­ï¸  kein Git-Repo"; exit 0; }

ROOT="$(git rev-parse --show-toplevel)"
REPO="$(basename "$ROOT")"
STAMP="$(date +%Y-%m-%dT%H-%M-%S)"
REPORT_DIR="$HOME/.hauski/review/$REPO"
LOG="$HOME/.hauski/logs/review.log"
INDEX_JSON="$HOME/.hauski/review/index.json"
OUT="$REPORT_DIR/$STAMP-review.md"

mkdir -p "$REPORT_DIR" "$HOME/.hauski/logs"
touch "$INDEX_JSON"

# Symlink im Repo fÃ¼r bequemen Zugriff (nicht committen)
cd "$ROOT"
[ -e .hauski-reports ] || ln -s "$REPORT_DIR" .hauski-reports 2>/dev/null || true

# --- Smart/Quick-Flags (ohne ripgrep) ---
changed=$(git diff --name-only HEAD 2>/dev/null || git ls-files)
if echo "$changed" | grep -Eq '\.(rs|toml|sh|py|ts|js|go|c|cpp)$'; then
  FAST_FLAGS="--fast --heavy"
else
  FAST_FLAGS="--fast"
fi

# --- pr-review Binary robust finden ---
PR_REVIEW_BIN="$(command -v pr-review || true)"
if [ -z "$PR_REVIEW_BIN" ]; then
  for cand in "$HOME/.local/bin/pr-review" "$HOME/bin/pr-review" "/usr/local/bin/pr-review" "/usr/bin/pr-review"; do
    [ -x "$cand" ] && PR_REVIEW_BIN="$cand" && break
  done
fi

write_stub() {
  {
    echo "# Review ($STAMP)"
    echo
    echo "**Hinweis:** \`pr-review\` nicht gefunden oder nicht ausfÃ¼hrbar."
    echo
    echo "**PATH:** \`$PATH\`"
  } > "$OUT"
  echo "ğŸŸ  Stub-Report geschrieben: $OUT" | tee -a "$LOG"
}

update_index() {
  # JSON-Index aktualisieren (wenn jq fehlt, einfache Textzeile)
  if command -v jq >/dev/null 2>&1; then
    tmp="$OUT.idx.tmp"
    jq -cn --arg repo "$REPO" --arg path "$OUT" --arg ts "$STAMP" \
      '{repo:$repo, path:$path, ts:$ts}' > "$tmp"
    if [ -s "$INDEX_JSON" ]; then
      jq -s '.[0] as $new | (.[1] // []) + [$new] | (.[-500:])' "$tmp" "$INDEX_JSON" > "$INDEX_JSON.tmp" || cp "$INDEX_JSON" "$INDEX_JSON.tmp"
    else
      jq -s '.[0]' "$tmp" > "$INDEX_JSON.tmp"
    fi
    mv "$INDEX_JSON.tmp" "$INDEX_JSON"
    rm -f "$tmp"
  else
    echo "$STAMP  $REPO  $OUT" >> "${INDEX_JSON%.json}.log"
  fi
}

echo "[hauski] start $REPO flags:$FAST_FLAGS" | tee -a "$LOG"

# --- Review ausfÃ¼hren oder Stub schreiben ---
if [ -z "$PR_REVIEW_BIN" ]; then
  write_stub
else
  # pr-review laufen lassen; selbst bei Fehlern ein lesbarer Report
  if ! "$PR_REVIEW_BIN" --local $FAST_FLAGS > "$OUT" 2>&1; then
    echo "âš ï¸  pr-review exitâ‰ 0 (s. Report): $OUT" | tee -a "$LOG"
    [ -s "$OUT" ] || write_stub
  fi
fi

update_index
echo "[hauski] saved $OUT" | tee -a "$LOG"

# --- Dashboard aktualisieren (fallback am Ende) ---
/home/alex/.hauski/bin/hauski-dashboard-build --no-open >/dev/null 2>&1 || true


# --- Notify bei kritischen Befunden ---
if command -v notify-send >/dev/null 2>&1; then
  if grep -Eiq "(TESTS-FAILED|security|critical|audit.*unmaintained|clippy.*ISSUES)" "$OUT"; then
    notify-send -u normal "HausKI Review: âš ï¸ ${REPO}" "Sieh dir den neuen Report an: $OUT"
  fi
fi


# --- HausKI Add-ons ---
# still: Notifier â†’ PR-Kommentar â†’ Gate (Fehler ignorieren)
[ -x "$HOME/.hauski/bin/hauski-notify" ]   && "$HOME/.hauski/bin/hauski-notify"   >/dev/null 2>&1 || true
[ -x "$HOME/.hauski/bin/hauski-pr-bot" ]   && "$HOME/.hauski/bin/hauski-pr-bot"   >/dev/null 2>&1 || true
[ -x "$HOME/.hauski/bin/hauski-gate" ]     && "$HOME/.hauski/bin/hauski-gate"     >/dev/null 2>&1 || true
# Dashboard still aktualisieren (falls nicht schon eingebaut)
[ -x "$HOME/.hauski/bin/hauski-dashboard-build" ] && "$HOME/.hauski/bin/hauski-dashboard-build" --no-open >/dev/null 2>&1 || true
